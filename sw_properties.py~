# # Default values (?)
# T = 20.0
# S = 0.0
# outputUnits = 'cgs'
# uT = 'C' 
# uS = 'ppt'

import numpy as np


def parse_units(T=20., S=0., uT='C', uS='ppt'):
    '''
    Returns temperature and salinity in degC and ppt, the default values for
    this suite of programmes.

    Also checks that the variables are within the tolerated range.
    '''
    # Temperature unit checks
    uT = uT.lower()
    if uT == 'c':
        pass
    elif uT == 'k':
        T -= 273.15
    elif uT == 'f':
        T = 5./9. * (T - 32.)
    elif uT == 'r':
        T = 5./9. * (T - 491.67)
    else:
        raise TypeError('Not a recognized temperature unit.  '
                        + 'Please use "C", "K", "F", or "R"')
    uT = 'C'
    
    # Salinity unit checks
    uS = uS.lower()
    if uS == 'ppt':
        pass
    elif uS == 'ppm':
        S = S / 1000
    elif uS == 'w':
        S = S * 1000
    elif uS == '%':
        S = S * 100
    else:
        raise TypeError('Not a recognized temperature unit.  '
                        + 'Please use "ppt", "ppm", "w", or "%"')
    uS = 'ppt'

    # Warnings for temperature or salinity out of range
    assert ((0 <= T <= 180) and (0 <= S <= 150)), 'Temperature and/or ' \
        + 'salinity are outside of accepted ranges: 0 <= T <= 180 degC, ' \
        + '0 <= S <= 150 g/kg'

    S /= 1000   # Following routines require S in [kg/kg]

    return T, S


def density(T=20.0, S=0.0, uT='C', uS='ppt', units='cgs'):
    """
    What follows below is the original matlab documentation.  This needs
    updating for full python compatibility.

    Currently, the input for temperature is expected in centigrade and 
    salinity in ppt.

    Description:
    ------------
    Density of seawater at atmospheric pressure (0.1 MPa) using Eq. (8)
    given by [1] which best fit the data of [2] and [3]. The pure water
    density equation is a best fit to the data of [4]. 
    Values at temperature higher than the normal boiling temperature are
    calculated at the saturation pressure.
    
    Parameters:
    -----------
    T : float
        temperature 
    S : float
        salinity
    uT : str
        temperature unit, taking values of:
        'C'  : [degree Celsius] (ITS-90)
        'K'  : [Kelvin]
        'F'  : [degree Fahrenheit] 
        'R'  : [Rankine]
    uS : str
        salinity unit, possible values are:
        'ppt': [g/kg]  (reference-composition salinity)
        'ppm': [mg/kg] (in parts per million)
        'w'  : [kg/kg] (mass fraction)
        '%'  : [kg/kg] (in parts per hundred)
    units : str
        the set of units for the output, one of 'cgs' or 'mks'
           
    Output:
    -------
    rho : float
        density
    
    VALIDITY: 0 < T < 180 C; 0 < S < 160 g/kg
     
    ACCURACY: 0.1%
    
    Revision history:
    -----------------
    2009-12-18: Mostafa H. Sharqawy (mhamed@mit.edu), MIT
                - Initial version
    2012-06-06: Karan H. Mistry (mistry@mit.edu), MIT
                - Allow T,S input in various units
                - Allow T,S to be matrices of any size
    2016-09-07: D. E. Jessop
                - Rewritten in python

    Disclaimer:
    -----------
    This software is provided "as is" without warranty of any kind.
    See the file sw_copy.m for conditions of use and license.
    
    References:
    [1] M. H. Sharqawy, J. H. Lienhard V, and S. M. Zubair, Desalination
        and Water Treatment, 16, 354-380, 2010. (http://web.mit.edu/seawater/)
    [2] Isdale, and Morris, Desalination, 10(4), 329, 1972.
    [3] Millero and Poisson, Deep-Sea Research, 28A (6), 625, 1981
    [4] IAPWS release on the Thermodynamic properties of ordinary water 
        substance, 1996. 
    =====================================================================
    """

    T, S, uT, uS = parse_units(T, S, uT, uS)
    rhoSW        = densityPlainWater(T) + deltaRho(T, S)

    if units.lower() == 'cgs':
        rhoSW /= 1e3
        return rhoSW
    else:
        return rhoSW


def densityPlainWater(T=20.):
    '''
    Description:
    ------------
    Density of plain water, best fit to data from [4].

    Parameters:
    -----------
    T : float
        temperature 
           
    Output:
    -------
    densityPW : float
        density of plain water/[kg/m**3]

    '''

    a = [9.9992293295E+02,      # 0
        2.0341179217E-02,    
        -6.1624591598E-03,    
        2.2614664708E-05,    
        -4.6570659168E-08]      # 4

    return a[0] + a[1]*T + a[2]*T**2 + a[3]*T**3 + a[4]*T**4


def deltaRho(T=20., S=0.):
    '''
    Increase in density 
    '''

    b = [
        8.0200240891E+02,    
        -2.0005183488E+00,    
        1.6771024982E-02,    
        -3.0600536746E-05,    
        -1.6132224742E-05,    
        ]

    return b[0]*S + b[1]*S*T + b[2]*S*T**2 + b[3]*S*T**3 + b[4]*S**2*T**2


def dynamicViscosity(T=20.0, S=0.0, uT='C', uS='ppt', units='cgs'):
    """
    dynamicViscosity    Dynamic viscosity of seawater

    Description:
    ------------
    Dynamic viscosity of seawater at atmospheric pressure (0.1 MPa) using
    Eq. (22) given in [1] which best fit the data of [2], [3] and [4].
    The pure water viscosity equation is a best fit to the data of [5].
    Values at temperature higher than the normal boiling temperature
    are calculated at the saturation pressure.
    
    Parameters:
    -----------
    T : float
        temperature 
    S : float
        salinity
    uT : str
        temperature unit, taking values of:
        'C'  : [degree Celsius] (ITS-90)
        'K'  : [Kelvin]
        'F'  : [degree Fahrenheit] 
        'R'  : [Rankine]
    uS : str
        salinity unit, possible values are:
        'ppt': [g/kg]  (reference-composition salinity)
        'ppm': [mg/kg] (in parts per million)
        'w'  : [kg/kg] (mass fraction)
        '%'  : [kg/kg] (in parts per hundred)
    units : str
        the set of units for the output, one of 'cgs' or 'mks'

    Outputs:
    --------
    mu : float
        dynamic viscosity
    
    Validity: 0 < T < 180 C and 0 < S < 150 g/kg;
    Accuracy: 1.5%
    
    Revision history:
    -----------------
    2009-12-18: Mostafa H. Sharqawy (mhamed@mit.edu), MIT
                - Initial version
    2012-06-06: Karan H. Mistry (mistry@mit.edu), MIT
                - Allow T,S input in various units
                - Allow T,S to be matrices of any size

    Disclaimer:
    -----------
    This software is provided "as is" without warranty of any kind.
    See the file sw_copy.m for conditions of use and licence.
    
    References:
    -----------
    [1] M. H. Sharqawy, J. H. Lienhard V, and S. M. Zubair, Desalination
        and Water Treatment, 16, 354-380, 2010. (http://web.mit.edu/seawater/)
    [2] B. M. Fabuss, A. Korosi, and D. F. Othmer, J., Chem. Eng. Data 14(2), 
        192, 1969.
    [3] J. D. Isdale, C. M. Spence, and J. S. Tudhope, Desalination, 10(4), 
        319 - 328, 1972
    [4] F. J. Millero, The Sea, Vol. 5, 3  80, John Wiley, New York, 1974
    [5] IAPWS release on the viscosity of ordinary water substance 2008
    """

    T, S, uT, uS = parse_units(T, S, uT, uS)

    # Array of constants
    a = [1.5700386464E-01,      # 0
        6.4992620050E+01,
       -9.1296496657E+01,
        4.2844324477E-05,       
        1.5409136040E+00,       # 4
        1.9981117208E-02,
       -9.5203865864E-05,
        7.9739318223E+00,
       -7.5614568881E-02,       # 8
        4.7237011074E-04]

    # Build temporary constants
    mu_temp = a[3] + 1.0 / (a[0] * (T + a[1])**2 + a[2])
    A  = a[4] + a[5] * T + a[6] * T**2
    B  = a[7] + a[8] * T + a[9] * T**2

    mu = mu_temp * (1 + A * S + B * S**2) # in mks

    # Check for units
    if units.lower() == 'cgs':
        return mu * 10
    else:
        print(mu)
        return mu


def kinematicViscosity(T=20., S=0., uT='C', uS='ppt', units='cgs'):
    '''
    Description:
    ------------
    Kinematic viscosity of seawater at atmospheric pressure (0.1 MPa) using
    dynamic viscosity and density correlations given in [1]
    Values at temperature higher than the normal boiling temperature
    are calculated at the saturation pressure.

    Parameters:
    -----------
    T : float
        temperature 
    S : float
        salinity
    uT : str
        temperature unit, taking values of:
        'C'  : [degree Celsius] (ITS-90)
        'K'  : [Kelvin]
        'F'  : [degree Fahrenheit] 
        'R'  : [Rankine]
    uS : str
        salinity unit, possible values are:
        'ppt': [g/kg]  (reference-composition salinity)
        'ppm': [mg/kg] (in parts per million)
        'w'  : [kg/kg] (mass fraction)
        '%'  : [kg/kg] (in parts per hundred)
    units : str
        the set of units for the output, one of 'cgs' or 'mks'

    Output:
    -------
    nu : float
        specific kinematic viscosity

    Validity: 0 < T < 180 C and 0 < S < 150 g/kg;
    Accuracy: 1.5% (estimated at average value within the range)

    Revision history:
    -----------------
    2009-12-18: Mostafa H. Sharqawy (mhamed@mit.edu), MIT
                - Initial version
    2012-06-06: Karan H. Mistry (mistry@mit.edu), MIT
                - Allow T,S input in various units
                - Allow T,S to be matrices of any size

    Disclaimer:
    -----------
    This software is provided "as is" without warranty of any kind.
    See the file sw_copy.m for conditions of use and licence.

    References:
    -----------
    [1] M. H. Sharqawy, J. H. Lienhard V, and S. M. Zubair, Desalination
        and Water Treatment, 16, 354-380, 2010. (http://web.mit.edu/seawater/)
    '''

    mu  = dynamicViscosity(T, S, uT, uS, units)
    rho = density(T, S, uT, uS, units)

    return mu / rho

